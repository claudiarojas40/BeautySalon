@model IEnumerable<BeautySalon.Models.DetalleVenta>

@{
    ViewData["Title"] = "Detalle de Venta";
}

@if (TempData["ErrorMessage"] != null)
{
    <div id="errorMessage" class="alert alert-danger" role="alert">
        <span style="color: red; font-size: 20px; font-weight: bold;">&times;</span>
        @TempData["ErrorMessage"]
    </div>

    <script>
        setTimeout(function () {
            var messageDiv = document.getElementById("errorMessage");
            if (messageDiv) {
                messageDiv.style.display = "none";
            }
        }, 5000);
    </script>
}

<head>
    <link rel="stylesheet" href="~/css/Crud.css" />
</head>

<h1>Detalle de Venta</h1>

<!-- Información de Venta -->
<div class="input-group">
    <label>Fecha:</label>
    <input type="date" />
    <label>Nombre:</label>
    <input type="text" />
    <label>Dirección:</label>
    <input type="text" />
</div>

<select id="terminoBusqueda" class="form-control">
    <option value="">Seleccione un producto</option>
    @foreach (var producto in ViewBag.Producto)
    {
        <option value="@producto.Id" data-precio="@producto.PrecioUnitario">
            @producto.Nombre
        </option>
    }
</select>
<button onclick="agregarProducto()" class="btn btn-primary">+</button>



<table id="resultadosBusqueda" class="table">
    <thead>
        <tr>
            <th>Cantidad</th>
            <th>Descripción</th>
            <th>Precio</th>
            <th>Suma</th>
        </tr>
    </thead>
    <tbody>
        <!-- Aquí se mostrarán los productos seleccionados -->
    </tbody>
</table>

<div>Descuento: <input type="text" name="descuento" value="0" oninput="calculateTotals()" /></div>
<div>IVA: <input type="text" name="IVA" readonly value="0" /></div>
<div>Total a Pagar: <input type="text" name="Total" readonly value="0" /></div>
<button class="btn-add">Procesar</button>

<script>
    function agregarProducto() {
        var selectProducto = document.getElementById("terminoBusqueda");
        var idProducto = selectProducto.value;
        var nombreProducto = selectProducto.options[selectProducto.selectedIndex].text;
        var precioProducto = parseFloat(selectProducto.options[selectProducto.selectedIndex].getAttribute("data-precio"));

        if (!idProducto) {
            alert("Por favor, seleccione un producto.");
            return;
        }

        // Añadir el producto a la tabla
        var tbody = document.getElementById("resultadosBusqueda").getElementsByTagName("tbody")[0];
        var row = tbody.insertRow();

        // Columnas: Cantidad, Descripción, Precio, Suma
        var cantidadCell = row.insertCell(0);
        var descripcionCell = row.insertCell(1);
        var precioCell = row.insertCell(2);
        var sumaCell = row.insertCell(3);

        cantidadCell.innerHTML = '<input type="number" value="1" min="1" onchange="actualizarSuma(this)" />';
        descripcionCell.innerText = nombreProducto;
        precioCell.innerText = precioProducto.toFixed(2);
        sumaCell.innerText = precioProducto.toFixed(2);

        // Recalcular los totales
        calculateTotals();
    }

    function actualizarSuma(input) {
        var cantidad = parseFloat(input.value);
        var precioUnitario = parseFloat(input.closest("tr").cells[2].innerText);
        var sumaCell = input.closest("tr").cells[3];

        // Actualizar la suma en la fila actual
        sumaCell.innerText = (cantidad * precioUnitario).toFixed(2);

        // Recalcular los totales
        calculateTotals();
    }

    function calculateTotals() {
        var subtotal = 0;
        var ivaRate = 0.13; // 13% de IVA, ajusta según tus necesidades
        var descuento = parseFloat(document.querySelector("input[name='descuento']").value) || 0;

        // Sumar todas las cantidades en la columna de Suma
        var tbody = document.getElementById("resultadosBusqueda").getElementsByTagName("tbody")[0];
        Array.from(tbody.rows).forEach(row => {
            var suma = parseFloat(row.cells[3].innerText);
            subtotal += suma;
        });

        // Cálculos
        var iva = subtotal * ivaRate;
        var total = subtotal + iva - descuento;

        // Mostrar los valores en los campos correspondientes
        document.querySelector("input[name='IVA']").value = iva.toFixed(2);
        document.querySelector("input[name='Total']").value = total.toFixed(2);
    }
</script>
