@model IEnumerable<BeautySalon.Models.DetalleVenta>

@{
    ViewData["Title"] = "Detalle de Venta";
}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="~/css/Crud.css" />
    <title>@ViewData["Title"]</title>
</head>
<body>
    <h1>Detalle de Venta</h1>

    <!-- Formulario para procesar la venta -->
    <form action="/DetalleVenta/ProcesarVenta" method="post">
        <input type="hidden" id="Fecha" name="Fecha" value="@DateTime.Now.ToString("yyyy-MM-dd")" />
        <div class="form-group">
            <label for="Nombre">Nombre:</label>
            <input type="text" id="Nombre" name="Nombre" class="form-control" required />
        </div>
        <div class="form-group">
            <label for="Direccion">Dirección:</label>
            <input type="text" id="Direccion" name="Direccion" class="form-control" required />
        </div>

        <!-- Campo oculto para los detalles -->
        <input type="hidden" id="Detalles" name="DetallesJson" />

        <!-- Selección de productos -->
        <div class="form-group">
            <label for="terminoBusqueda">Seleccione un producto:</label>
            <select id="terminoBusqueda" class="form-control">
                <option value="">Seleccione un producto</option>
                @foreach (var producto in ViewBag.Producto)
                {
                    <option value="@producto.Id" data-precio="@producto.PrecioUnitario">
                        @producto.Nombre
                    </option>
                }
            </select>
            <button type="button" onclick="agregarProducto()" class="btn btn-primary mt-2">Agregar Producto</button>
        </div>

        <!-- Tabla de productos -->
        <table id="resultadosBusqueda" class="table table-striped">
            <thead>
                <tr>
                    <th>Cantidad</th>
                    <th>Descripción</th>
                    <th>Precio Unitario</th>
                    <th>Total</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                <!-- Aquí se agregarán los productos seleccionados -->
            </tbody>
        </table>

        <!-- Totales -->
        <div class="form-group">
            <label for="descuento">Descuento:</label>
            <input type="number" id="descuento" name="descuento" value="0" class="form-control" oninput="calculateTotals()" />
        </div>
        <div class="form-group">
            <label for="IVA">IVA:</label>
            <input type="text" id="IVA" name="IVA" readonly class="form-control" value="0" />
        </div>
        <div class="form-group">
            <label for="Total">Total a Pagar:</label>
            <input type="text" id="Total" name="Total" readonly class="form-control" value="0" />
        </div>
        <button onclick="procesarVenta()" class="btn-add">Procesar</button>
    </form>

    <!-- Script de funcionalidad -->
    <script>
        function agregarProducto() {
            const selectProducto = document.getElementById("terminoBusqueda");
            const idProducto = selectProducto.value;
            const nombreProducto = selectProducto.options[selectProducto.selectedIndex].text;
            const precioProducto = parseFloat(selectProducto.options[selectProducto.selectedIndex].getAttribute("data-precio"));

            if (!idProducto) {
                alert("Por favor, seleccione un producto.");
                return;
            }

            // Añadir producto a la tabla
            const tbody = document.getElementById("resultadosBusqueda").getElementsByTagName("tbody")[0];
            const row = tbody.insertRow();

            // Crear columnas: Cantidad, Descripción, Precio, Total, Acciones
            row.innerHTML = `
                                <td><input type="number" value="1" min="1" class="form-control" onchange="actualizarSuma(this)" /></td>
                                <td data-id="${idProducto}">${nombreProducto}</td>
                                <td>${precioProducto.toFixed(2)}</td>
                                <td>${precioProducto.toFixed(2)}</td>
                                <td><button type="button" class="btn btn-danger btn-sm" onclick="eliminarProducto(this)">Eliminar</button></td>
                            `;

            calculateTotals();
        }

        function actualizarSuma(input) {
            const cantidad = parseFloat(input.value);
            const precioUnitario = parseFloat(input.closest("tr").cells[2].innerText);
            const sumaCell = input.closest("tr").cells[3];

            // Actualizar la suma en la fila actual
            sumaCell.innerText = (cantidad * precioUnitario).toFixed(2);

            calculateTotals();
        }

        function eliminarProducto(button) {
            const row = button.closest("tr");
            row.remove();
            calculateTotals();
        }

        function calculateTotals() {
            let subtotal = 0;
            const ivaRate = 0.13; // IVA 13%
            const descuento = parseFloat(document.getElementById("descuento").value) || 0;

            // Sumar los totales de cada fila
            const rows = document.querySelectorAll("#resultadosBusqueda tbody tr");
            rows.forEach(row => {
                const total = parseFloat(row.cells[3].innerText);
                subtotal += total;
            });

            const iva = subtotal * ivaRate;
            const total = subtotal + iva - descuento;

            // Mostrar resultados
            document.getElementById("IVA").value = iva.toFixed(2);
            document.getElementById("Total").value = total.toFixed(2);
        }

        document.querySelector("form").addEventListener("submit", function () {
            const detalles = [];
            const rows = document.querySelectorAll("#resultadosBusqueda tbody tr");
            rows.forEach(row => {
                const cantidad = parseInt(row.cells[0].querySelector("input").value);
                const idProducto = row.cells[1].getAttribute("data-id");
                const precioUnitario = parseFloat(row.cells[2].innerText);
                detalles.push({ IdProducto: idProducto, Cantidad: cantidad, PrecioUnitario: precioUnitario });
            });
            document.getElementById("Detalles").value = JSON.stringify(detalles);
        });
    </script>
</body>
</html>